---
/**
 * InstallTabs Component
 * 
 * Platform-specific installation commands with tabbed interface.
 * Supports Windows, macOS, and Linux with copy functionality.
 */

import CodeBlock from './CodeBlock.astro';

interface Props {
  /** Default selected platform */
  defaultPlatform?: 'windows' | 'macos' | 'linux';
  /** Additional CSS classes */
  class?: string;
}

const { defaultPlatform = 'windows', class: className = '' } = Astro.props;

// Platform installation commands
const platforms = [
  {
    id: 'windows',
    name: 'Windows',
    icon: `<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
      <path d="M0 3.449L9.75 2.1v9.451H0m10.949-9.602L24 0v11.4H10.949M0 12.6h9.75v9.451L0 20.699M10.949 12.6H24V24l-12.9-1.801"/>
    </svg>`,
    commands: `# Install Azure Developer CLI
winget install microsoft.azd

# Add extension source
azd extension source add -n jongio -t url -l https://jongio.github.io/azd-extensions/registry.json

# Install extension
azd extension install jongio.azd.rest`,
  },
  {
    id: 'macos',
    name: 'macOS',
    icon: `<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
      <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
    </svg>`,
    commands: `# Install Azure Developer CLI
brew tap azure/azd && brew install azd

# Add extension source
azd extension source add -n jongio -t url -l https://jongio.github.io/azd-extensions/registry.json

# Install extension
azd extension install jongio.azd.rest`,
  },
  {
    id: 'linux',
    name: 'Linux',
    icon: `<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
      <path d="M12.504 0c-.155 0-.315.008-.48.021-4.226.333-3.105 4.807-3.17 6.298-.076 1.092-.3 1.953-1.05 3.02-.885 1.051-2.127 2.75-2.716 4.521-.278.832-.41 1.684-.287 2.489a.424.424 0 00-.11.135c-.26.268-.45.6-.663.839-.199.199-.485.267-.797.4-.313.136-.658.269-.864.68-.09.189-.136.394-.132.602 0 .199.027.4.055.536.058.399.116.728.04.97-.249.68-.28 1.145-.106 1.484.174.334.535.47.94.601.81.2 1.91.135 2.774-.6.926-.776 1.38-1.843 1.706-2.779.326-.935.522-1.729.93-2.35.408-.62.896-1.042 1.413-1.257.518-.215 1.067-.258 1.605-.166.537.092 1.062.295 1.535.605.473.31.893.729 1.234 1.235.342.506.604 1.1.769 1.757.165.657.232 1.376.195 2.129-.037.753-.185 1.538-.51 2.32-.325.782-.8 1.558-1.466 2.277-.666.72-1.524 1.382-2.527 1.942-1.003.56-2.152 1.018-3.38 1.312-1.228.294-2.536.424-3.844.394-1.308-.03-2.616-.18-3.866-.483-1.25-.302-2.44-.756-3.488-1.328-1.048-.572-1.953-1.262-2.67-2.045-.717-.783-1.245-1.66-1.58-2.605-.335-.946-.477-1.96-.423-2.977.054-1.017.26-2.037.623-3.017.363-.98.881-1.92 1.547-2.785.666-.865 1.48-1.654 2.425-2.336.945-.682 2.02-1.258 3.194-1.707 1.174-.449 2.447-.771 3.77-.955 1.323-.184 2.696-.23 4.065-.137 1.37.093 2.736.303 4.048.622 1.312.319 2.57.747 3.729 1.27 1.159.523 2.22 1.141 3.143 1.842.923.701 1.708 1.485 2.328 2.34.62.855 1.075 1.781 1.361 2.76.286.979.403 2.011.349 3.034-.054 1.023-.26 2.037-.623 3.017-.363.98-.881 1.92-1.547 2.785-.666.865-1.48 1.654-2.425 2.336-.945.682-2.02 1.258-3.194 1.707-1.174.449-2.447.771-3.77.955-1.323.184-2.696.23-4.065.137z"/>
    </svg>`,
    commands: `# Install Azure Developer CLI
curl -fsSL https://aka.ms/install-azd.sh | bash

# Add extension source
azd extension source add -n jongio -t url -l https://jongio.github.io/azd-extensions/registry.json

# Install extension
azd extension install jongio.azd.rest`,
  },
];
---

<div class:list={['install-tabs', className]} role="tablist" aria-label="Installation instructions by platform">
  <!-- Tab Buttons -->
  <div class="install-tabs-buttons">
    {platforms.map((platform, index) => (
      <button
        type="button"
        role="tab"
        id={`tab-${platform.id}`}
        aria-selected={platform.id === defaultPlatform ? 'true' : 'false'}
        aria-controls={`panel-${platform.id}`}
        class:list={['install-tab', { 'install-tab--active': platform.id === defaultPlatform }]}
        data-platform={platform.id}
        tabindex={platform.id === defaultPlatform ? 0 : -1}
      >
        <span class="install-tab-icon" set:html={platform.icon} />
        <span class="install-tab-name">{platform.name}</span>
      </button>
    ))}
  </div>

  <!-- Tab Panels -->
  {platforms.map((platform) => (
    <div
      role="tabpanel"
      id={`panel-${platform.id}`}
      aria-labelledby={`tab-${platform.id}`}
      class:list={['install-panel', { 'install-panel--active': platform.id === defaultPlatform }]}
      tabindex="0"
      hidden={platform.id !== defaultPlatform}
    >
      <CodeBlock 
        code={platform.commands}
        language="bash"
        showLanguage={true}
        showCopy={true}
      />
    </div>
  ))}
</div>

<style>
  .install-tabs {
    width: 100%;
    max-width: 800px;
    margin: 0 auto;
  }

  .install-tabs-buttons {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0;
    border-bottom: 1px solid var(--color-border-default);
    padding-bottom: 0;
  }

  .install-tab {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    background: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    font-size: 0.9375rem;
    font-weight: 500;
    color: var(--color-text-secondary);
    transition: color 150ms ease-out, border-color 150ms ease-out, background-color 150ms ease-out;
    margin-bottom: -1px;
  }

  .install-tab:hover {
    color: var(--color-text-primary);
    background-color: var(--color-bg-secondary);
  }

  .install-tab:focus-visible {
    outline: 2px solid var(--color-border-focus);
    outline-offset: -2px;
    border-radius: 0.25rem;
  }

  .install-tab--active {
    color: var(--color-interactive-default);
    border-bottom-color: var(--color-interactive-default);
  }

  .install-tab-icon {
    display: inline-flex;
    align-items: center;
    opacity: 0.7;
  }

  .install-tab--active .install-tab-icon {
    opacity: 1;
  }

  .install-panel {
    display: none;
  }

  .install-panel--active {
    display: block;
  }

  .install-panel :global(.code-block-wrapper) {
    margin-top: 0;
  }

  /* Mobile platform tabs */
  @media (max-width: 480px) {
    .install-tabs-buttons {
      flex-direction: column;
      gap: 0;
      border-bottom: none;
    }

    .install-tab {
      justify-content: flex-start;
      padding: 0.875rem 1rem;
      border-bottom: 1px solid var(--color-border-default);
      border-left: 3px solid transparent;
      margin-bottom: 0;
    }

    .install-tab--active {
      border-bottom-color: var(--color-border-default);
      border-left-color: var(--color-interactive-default);
      background-color: var(--color-bg-secondary);
    }
  }
</style>

<script>
  function initInstallTabs(): void {
    const tabContainers = document.querySelectorAll('.install-tabs');
    
    tabContainers.forEach((container) => {
      const tabs = container.querySelectorAll<HTMLButtonElement>('.install-tab');
      const panels = container.querySelectorAll<HTMLDivElement>('.install-panel');

      function selectTab(selectedTab: HTMLButtonElement): void {
        const platform = selectedTab.dataset.platform;

        // Update tabs
        tabs.forEach((tab) => {
          const isSelected = tab === selectedTab;
          tab.setAttribute('aria-selected', String(isSelected));
          tab.classList.toggle('install-tab--active', isSelected);
          tab.tabIndex = isSelected ? 0 : -1;
        });

        // Update panels
        panels.forEach((panel) => {
          const isActive = panel.id === `panel-${platform}`;
          panel.classList.toggle('install-panel--active', isActive);
          panel.hidden = !isActive;
        });
      }

      tabs.forEach((tab) => {
        tab.addEventListener('click', () => selectTab(tab));

        // Keyboard navigation
        tab.addEventListener('keydown', (e) => {
          const currentIndex = Array.from(tabs).indexOf(tab);
          let newIndex: number | null = null;

          if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
            e.preventDefault();
            newIndex = currentIndex === 0 ? tabs.length - 1 : currentIndex - 1;
          } else if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
            e.preventDefault();
            newIndex = currentIndex === tabs.length - 1 ? 0 : currentIndex + 1;
          } else if (e.key === 'Home') {
            e.preventDefault();
            newIndex = 0;
          } else if (e.key === 'End') {
            e.preventDefault();
            newIndex = tabs.length - 1;
          }

          if (newIndex !== null) {
            const newTab = tabs[newIndex];
            newTab.focus();
            selectTab(newTab);
          }
        });
      });
    });
  }

  // Auto-detect platform
  function detectPlatform(): void {
    const userAgent = navigator.userAgent.toLowerCase();
    let platform: string;

    if (userAgent.includes('win')) {
      platform = 'windows';
    } else if (userAgent.includes('mac')) {
      platform = 'macos';
    } else {
      platform = 'linux';
    }

    const tab = document.querySelector<HTMLButtonElement>(`.install-tab[data-platform="${platform}"]`);
    if (tab && tab.getAttribute('aria-selected') !== 'true') {
      tab.click();
    }
  }

  // Initialize
  initInstallTabs();
  detectPlatform();

  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', () => {
    initInstallTabs();
    detectPlatform();
  });
</script>
