name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  GO_VERSION: '1.26.0'

jobs:
  preflight:
    name: Preflight Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go (bootstrap)
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'
          cache: false

      - name: Install Go ${{ env.GO_VERSION }}
        run: |
          go install golang.org/dl/go${{ env.GO_VERSION }}@latest
          go${{ env.GO_VERSION }} download
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
          echo "GOROOT=$(go${{ env.GO_VERSION }} env GOROOT)" >> $GITHUB_ENV

      - name: Use Go ${{ env.GO_VERSION }}
        run: |
          ln -sf $(which go${{ env.GO_VERSION }}) $(go env GOPATH)/bin/go
          go version

      - name: Install golangci-lint
        run: go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@latest

      - name: Install gosec
        run: go install github.com/securego/gosec/v2/cmd/gosec@latest

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install cspell
        run: npm install -g cspell

      - name: Format check
        run: |
          if [ -n "$(gofmt -l ./cli/src/...)" ]; then
            echo "Go files need formatting:"
            gofmt -l ./cli/src/...
            exit 1
          fi

      - name: Lint
        run: golangci-lint run --timeout=5m ./cli/src/...

      - name: Security scan
        run: gosec -quiet -exclude=G204,G304 ./cli/src/...

      - name: Vulnerability check
        working-directory: cli
        run: govulncheck ./src/...

      - name: Spell check
        run: cspell "**/*.go" "**/*.md" --no-progress

  test:
    name: Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go (bootstrap)
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'
          cache: false

      - name: Install Go ${{ env.GO_VERSION }} (Unix)
        if: runner.os != 'Windows'
        run: |
          go install golang.org/dl/go${{ env.GO_VERSION }}@latest
          go${{ env.GO_VERSION }} download
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
          ln -sf $(which go${{ env.GO_VERSION }}) $(go env GOPATH)/bin/go

      - name: Install Go ${{ env.GO_VERSION }} (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          go install golang.org/dl/go${{ env.GO_VERSION }}@latest
          & go${{ env.GO_VERSION }} download
          $gopath = go env GOPATH
          "$gopath\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          Copy-Item "$gopath\bin\go${{ env.GO_VERSION }}.exe" "$gopath\bin\go.exe" -Force

      - name: Verify Go version
        run: go version

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        shell: bash
        run: |
          mkdir -p coverage
          if [ "${{ matrix.os }}" = "macos-latest" ]; then
            go test -short -v -coverprofile=coverage/coverage.out ./cli/src/...
          else
            go test -short -v -race -coverprofile=coverage/coverage.out ./cli/src/...
          fi

      - name: Upload coverage to Codecov
        if: github.repository == 'jongio/azd-rest'
        uses: codecov/codecov-action@v4
        with:
          file: coverage/coverage.out
          flags: unittests
          name: codecov-${{ matrix.os }}-go-${{ env.GO_VERSION }}
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false
          verbose: true

      - name: Generate coverage report
        if: matrix.os == 'ubuntu-latest' && github.event_name == 'pull_request'
        run: |
          go tool cover -func=coverage/coverage.out -o=coverage/coverage.txt
          echo "## Code Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat coverage/coverage.txt | tail -n 20 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          COVERAGE=$(go tool cover -func=coverage/coverage.out | grep total | awk '{print $3}')
          echo "**Total Coverage: $COVERAGE**" >> $GITHUB_STEP_SUMMARY

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [preflight, test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go (bootstrap)
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'
          cache: false

      - name: Install Go ${{ env.GO_VERSION }}
        run: |
          go install golang.org/dl/go${{ env.GO_VERSION }}@latest
          go${{ env.GO_VERSION }} download
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
          ln -sf $(which go${{ env.GO_VERSION }}) $(go env GOPATH)/bin/go

      - name: Verify Go version
        run: go version

      - name: Build for multiple platforms
        run: |
          GOOS=windows GOARCH=amd64 go build -o bin/windows-amd64/rest.exe ./cli/src/cmd/rest
          GOOS=windows GOARCH=arm64 go build -o bin/windows-arm64/rest.exe ./cli/src/cmd/rest
          GOOS=linux GOARCH=amd64 go build -o bin/linux-amd64/rest ./cli/src/cmd/rest
          GOOS=darwin GOARCH=amd64 go build -o bin/darwin-amd64/rest ./cli/src/cmd/rest
          GOOS=darwin GOARCH=arm64 go build -o bin/darwin-arm64/rest ./cli/src/cmd/rest

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries
          path: bin/
